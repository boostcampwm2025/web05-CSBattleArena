# 6. 트레이드오프 분석

> 아키텍처 결정사항, 비용 분석, 그리고 각 선택의 트레이드오프

## 핵심 제약 조건

| 항목 | 값 |
|------|-----|
| **월 예산** | 20~30만원 |
| **우선순위** | 비용 효율성 > 확장성 > 편의성 |

---

## 아키텍처 결정 매트릭스

### 전체 요약

| 결정 영역 | 선택 | 대안 | 이유 |
|----------|------|------|------|
| 컴퓨팅 | VM (Server) 2대 | Kubernetes (NKS) | 비용, 학습 곡선 |
| DB | Self-managed PostgreSQL | NCP Cloud DB | **비용 절감** (~10만원/월) |
| 세션 관리 | In-Memory (현재) | Redis | 단일 서버로 충분 |
| 프론트 배포 | Object Storage | CDN + Object Storage | **비용 절감** (~3만원/월) |
| LB | 미사용 (현재) | Network Proxy LB | **비용 절감** (~3만원/월) |
| CI/CD | GitHub Actions | NCP SourcePipeline | 무료, 친숙함 |

---

## 서버 분리 vs 단일 서버

### 선택: WAS + DB 서버 분리 (2대)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     서버 구성 비교                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   옵션 1: 단일 서버                    옵션 2: WAS + DB 분리 ✓ 선택        │
│                                                                              │
│   ┌─────────────────┐                  ┌─────────────────┐                  │
│   │   All-in-One    │                  │   WAS Server    │                  │
│   │  ┌───────────┐  │                  │  ┌───────────┐  │                  │
│   │  │ NestJS    │  │                  │  │  NestJS   │  │                  │
│   │  │ PostgreSQL│  │                  │  │  Nginx    │  │                  │
│   │  │ (Redis)   │  │                  │  └───────────┘  │                  │
│   │  └───────────┘  │                  └────────┬────────┘                  │
│   └─────────────────┘                           │                           │
│                                                  ▼                           │
│   비용: ~6만원/월                      ┌─────────────────┐                  │
│   장점: 단순                           │   DB Server     │                  │
│   단점: 단일 장애점,                   │  ┌───────────┐  │                  │
│         리소스 경합,                   │  │PostgreSQL │  │                  │
│         배포 시 DB 영향               │  │ (Redis)   │  │                  │
│                                        │  └───────────┘  │                  │
│                                        └─────────────────┘                  │
│                                                                              │
│                                        비용: ~12만원/월                      │
│                                        장점: 장애 격리, 보안, 확장 용이      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 서버 분리의 이점 상세

| 이점 | 상세 설명 |
|------|----------|
| **장애 격리** | WAS 배포/재시작 시 DB 영향 없음. DB 장애 시에도 WAS는 정상 (연결 대기) |
| **보안 강화** | DB를 Private Subnet에 배치, 외부 접근 원천 차단 |
| **리소스 최적화** | WAS는 CPU 중심, DB는 Memory/IO 중심으로 각각 최적화 가능 |
| **독립적 스케일링** | 향후 WAS만 추가하거나 DB 스펙만 업그레이드 가능 |
| **유지보수** | WAS 업데이트 시 DB 영향 없음, 독립적 백업/복구 |

### 추가 비용 대비 가치

```
서버 분리 추가 비용: +6만원/월

얻는 가치:
├── 장애 격리: WAS 배포 중단 없음
├── 보안: DB 외부 노출 방지
├── 향후 확장: 구조 변경 최소화
└── 운영 안정성: 리소스 경합 제거

결론: 6만원으로 운영 안정성 확보 → 합리적 투자
```

---

## WAS 다중화 여부

### 현재 선택: 단일 WAS (다중화 미적용)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     WAS 다중화 비교                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   단일 WAS (현재 선택)                 WAS 다중화 (미래 확장)               │
│                                                                              │
│   Client ──▶ WAS Server               Client ──▶ Load Balancer              │
│                 │                                    │                       │
│                 ▼                              ┌─────┴─────┐                 │
│           ┌─────────┐                         │           │                 │
│           │ NestJS  │                    ┌────▼───┐  ┌────▼───┐            │
│           └─────────┘                    │ WAS 1  │  │ WAS 2  │            │
│                                          └────┬───┘  └────┬───┘            │
│                                               └─────┬─────┘                 │
│   비용: 0원 추가                                    │                       │
│   장점: 단순, 저비용                          ┌─────▼─────┐                 │
│   단점: 단일 장애점,                          │   Redis   │                 │
│         무중단 배포 불가                      └───────────┘                 │
│                                                                              │
│                                          비용: +9만원/월 (LB + WAS + Redis) │
│                                          장점: 고가용성, 무중단 배포        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 다중화 미적용 이유

| 요소 | 현재 상황 |
|------|----------|
| **예산** | 다중화 시 +9만원/월 (예산 30% 이상 증가) |
| **트래픽** | 부트캠프 프로젝트 수준 (동시 접속 수십 명 예상) |
| **복잡도** | Redis 필수, Sticky Session 설정, Socket.IO Adapter 필요 |
| **장애 대응** | Docker 기반 빠른 재시작 가능 (다운타임 수 분) |

### 다중화 도입 기준 (미래)

다음 **모든 조건** 충족 시 도입 검토:

- [ ] 동시 접속자 100명 이상 **지속**
- [ ] CPU 사용률 70% 이상 **지속** (5분 이상)
- [ ] 무중단 배포 **필수** 요구
- [ ] 예산 40만원 이상 확보

---

## Database 선택

### 선택: Self-managed PostgreSQL

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    데이터베이스 옵션 비교                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                    NCP Cloud DB              Self-managed ✓ 선택           │
│                                                                              │
│   비용             ██████████ ~15만원/월     ████ ~6만원/월 (서버 포함)    │
│   관리 부담        ██ 낮음                   ████████ 높음                  │
│   HA (고가용성)    ██████████ 내장           ████ 수동 구성                 │
│   백업             ██████████ 자동           ████████ 수동 (cron)          │
│   확장 지원        ████ 제한적               ██████████ 자유 (pgvector 등) │
│   커스터마이징     ████ 제한적               ██████████ 완전                │
│                                                                              │
│   ────────────────────────────────────────────────────────────────────      │
│                                                                              │
│   비용 차이: ~9만원/월 절감                                                  │
│   트레이드오프: 관리 부담 증가, HA 직접 구성 필요                           │
│                                                                              │
│   결론: 비용 절감 우선 → Self-managed 선택                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Self-managed의 위험 완화

| 위험 | 완화 방안 |
|------|----------|
| 데이터 손실 | cron 기반 일일 백업 (pg_dump), 7일 보관 |
| 장애 복구 | Docker 기반 빠른 복구, 백업에서 복원 가능 |
| 성능 튜닝 | 기본 설정으로 충분 (현재 규모), 필요 시 튜닝 |
| 보안 | Private Subnet 배치, ACG로 접근 제한 |

---

## 세션 및 상태 관리

### 현재: In-Memory / 미래: Redis (선택적)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    세션 관리 옵션 비교                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                        In-Memory (현재)           Redis (미래 확장)         │
│                                                                              │
│   서버 확장          ✗ 불가능                    ✓ 가능                     │
│   서버 재시작        ✗ 데이터 소실               ✓ 데이터 유지              │
│   비용               $0                          ~0원 (DB 서버 내)          │
│                                                   ~3-4만원 (별도 서버)      │
│   지연 시간          ~0ms                        ~1-2ms                     │
│   복잡도             낮음                        중간                       │
│                                                                              │
│   ────────────────────────────────────────────────────────────────────      │
│                                                                              │
│   현재 상황:                                                                │
│   • 단일 WAS 운영 → In-Memory로 충분                                       │
│   • 서버 재시작 시 게임 중단 허용 가능 (부트캠프 프로젝트)                  │
│                                                                              │
│   Redis 도입 시점:                                                          │
│   • WAS 다중화 필요 시 (필수)                                              │
│   • 게임 상태 보존이 중요해질 때                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Redis 도입 시 얻는 이점

1. **세션 공유**: 여러 WAS 서버가 동일한 세션 접근
2. **Socket.IO Redis Adapter**: 서버 간 WebSocket 이벤트 전파
3. **매칭 큐 원자성**: LPUSH/LPOP으로 race condition 방지
4. **게임 상태 보존**: 서버 재시작 시에도 진행 중인 게임 유지
5. **캐싱**: 자주 조회되는 문제 데이터 캐싱으로 DB 부하 감소

---

## 프론트엔드 배포

### 선택: Object Storage (CDN 미사용)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Frontend 배포 방식 비교                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Object Storage (현재)                Object Storage + CDN (미래)          │
│   ┌─────────────────────────────┐      ┌─────────────────────────────┐     │
│   │  Client ──▶ Object Storage  │      │  Client ──▶ CDN ──▶ Storage │     │
│   │            (직접 접근)       │      │         (캐싱)               │     │
│   └─────────────────────────────┘      └─────────────────────────────┘     │
│                                                                              │
│   비용: ~1만원/월                       비용: ~4-6만원/월                   │
│   장점:                                 장점:                                │
│   • 단순                               • 글로벌 엣지 캐싱                   │
│   • 저비용                              • 커스텀 도메인 HTTPS               │
│                                         • DDoS 방어                         │
│   단점:                                                                      │
│   • 해외 사용자 지연                   단점:                                │
│   • 커스텀 도메인 제한적               • 추가 비용                          │
│                                                                              │
│   현재 선택 이유:                                                           │
│   • 국내 사용자 대상 → Object Storage 직접 접근도 충분                     │
│   • 비용 절감 우선                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## CI/CD 플랫폼

### 선택: GitHub Actions

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CI/CD 플랫폼 비교                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                    GitHub Actions ✓ 선택      NCP SourcePipeline            │
│                                                                              │
│   비용              무료 (public repo)         빌드 시간당 과금              │
│                     2000분/월 (private)                                      │
│                                                                              │
│   학습 곡선         낮음 (익숙함)              중간                          │
│                                                                              │
│   NCP 통합          수동 설정 필요             네이티브 통합                 │
│                                                                              │
│   유연성            높음                       NCP 서비스 한정               │
│                                                                              │
│   커뮤니티          매우 활발                  제한적                        │
│                                                                              │
│   ────────────────────────────────────────────────────────────────────      │
│                                                                              │
│   GitHub Actions 선택 이유:                                                 │
│   • 이미 GitHub 사용 중                                                     │
│   • 풍부한 액션 마켓플레이스                                                │
│   • YAML 기반 워크플로우에 익숙                                             │
│   • 무료 (public repo)                                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 비용 분석

### 현재 계획 비용

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          현재 계획 월간 비용                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  WAS Server (Standard, 2vCPU, 4GB)     ████████████ ~6만원                  │
│  DB Server (Standard, 2vCPU, 4GB)      ████████████ ~6만원                  │
│  Object Storage (10GB)                 ██ ~1만원                            │
│  네트워크 트래픽                        ████ ~2만원                          │
│                                        ─────────────────                    │
│                                        총: 약 15만원/월                     │
│                                                                              │
│  ✅ 예산 20~30만원 내 충분한 여유                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 확장 시나리오별 비용

| 시나리오 | 추가 비용 | 총 비용 | 예산 내 |
|----------|----------|---------|---------|
| **현재 계획** | - | ~15만원 | ✅ |
| + Redis (DB 서버 내) | +0원 | ~15만원 | ✅ |
| + Cloud Insight | +2만원 | ~17만원 | ✅ |
| + Redis (별도 서버) | +4만원 | ~19만원 | ✅ |
| + CDN | +4만원 | ~23만원 | ⚠️ |
| + Load Balancer | +3만원 | ~26만원 | ⚠️ |
| + 추가 WAS | +6만원 | ~32만원 | ❌ |

### 예산 초과 시 우선순위

비용 절감이 필요한 경우, 다음 순서로 제거 고려:

1. CDN (국내 서비스로 큰 영향 없음)
2. Cloud Insight (기본 모니터링으로 대체)
3. 별도 Redis 서버 (DB 서버 내로 통합)

---

## 확장성 vs 비용 트레이드오프

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      확장성 vs 비용 그래프                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   비용                                                                       │
│   (만원/월)                                                                 │
│     ▲                                                                        │
│  50 │                                          ★ Full Scale                 │
│     │                                         /  (LB + WAS x2 + Redis)      │
│  40 │                                        /                               │
│     │                                       /                                │
│  30 │                        ────────────★ 예산 상한                        │
│     │                       /              (CDN + 모니터링)                  │
│  20 │                      /                                                 │
│     │            ★ 현재 계획                                                │
│  15 │           / (WAS + DB 분리)                                           │
│     │          /                                                             │
│  10 │         /                                                              │
│     │        /                                                               │
│     │───────────────────────────────────────────────────────────▶ 확장성   │
│              단일 서버   2대 분리   Redis 추가   WAS 다중화                 │
│                                                                              │
│   현재 선택: 2대 분리 (~15만원)                                             │
│   이유: 비용 대비 가장 높은 안정성 확보                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 기술 부채 관리

### 현재 기술 부채

| 영역 | 현재 상태 | 이상적 상태 | 우선순위 | 비용 |
|------|----------|------------|----------|------|
| 세션 관리 | In-Memory | Redis | **높음** (확장 차단) | +0~4만원 |
| 모니터링 | 기본 콘솔 | Cloud Insight | 중간 | +2만원 |
| 백업 | 수동 스크립트 | 자동화 + 원격 저장 | 중간 | +1만원 |
| HA | 단일 서버 | WAS 다중화 | 낮음 (현재) | +9만원 |

### 기술 부채 해결 우선순위

1. **백업 자동화** (필수, 비용 최소)
   - cron 스크립트 설정
   - Object Storage에 백업 저장 고려

2. **Redis 도입 준비** (코드 레벨)
   - 세션/매칭 로직 추상화
   - 실제 Redis 연동은 필요 시

3. **모니터링 강화** (서비스 안정화 후)
   - Cloud Insight 도입
   - 알람 설정

---

## 의사 결정 가이드

### 확장 결정 기준

| 지표 | 임계값 | 조치 |
|------|--------|------|
| CPU 사용률 | > 70% (5분 지속) | 원인 분석 → 스케일업 또는 최적화 |
| 메모리 사용률 | > 80% | 메모리 누수 확인 → 스케일업 |
| 동시 접속 | > 50명/서버 | WAS 다중화 검토 |
| 응답 시간 | > 500ms | 병목 분석 |
| 에러율 | > 1% | 즉시 조사 |

### 비용 증가 시 체크리스트

```
□ 현재 문제를 명확히 정의했는가?
□ 비용 증가 없이 해결할 방법은 없는가?
□ 예산 내에서 가능한가?
□ ROI가 명확한가?
□ 롤백 계획이 있는가?
```

---

## 최종 권장 구성

### 현재 목표 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      현재 목표 구성 (~15만원/월)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Compute:                                                                  │
│   • WAS Server (Standard, 2vCPU, 4GB)                                      │
│   • DB Server (Standard, 2vCPU, 4GB)                                       │
│                                                                              │
│   Database:                                                                 │
│   • Self-managed PostgreSQL 18 (Docker)                                    │
│   • 일일 자동 백업 (cron + pg_dump)                                        │
│                                                                              │
│   Storage:                                                                  │
│   • Object Storage (Frontend 정적 파일)                                    │
│                                                                              │
│   Session:                                                                  │
│   • In-Memory (단일 서버로 충분)                                           │
│                                                                              │
│   CI/CD:                                                                    │
│   • GitHub Actions                                                         │
│                                                                              │
│   Monitoring:                                                               │
│   • NCP 콘솔 기본 모니터링                                                 │
│                                                                              │
│   ────────────────────────────────────────────────────────────────────      │
│                                                                              │
│   특징:                                                                      │
│   ✅ 예산 내 충분한 여유 (15만원 < 20~30만원)                               │
│   ✅ 서버 분리로 안정성 확보                                                │
│   ✅ Self-managed DB로 비용 절감                                            │
│   ✅ 확장 가능한 구조 (Redis/LB 추가 용이)                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 미래 확장 경로

```
현재 (~15만원)              단계 1 (~20만원)           단계 2 (~35만원)
─────────────────────────────────────────────────────────────────────────
WAS + DB 분리          ──▶  + Redis (DB 서버 내)  ──▶  + LB + WAS 추가
In-Memory                    + Cloud Insight             + Redis 분리
Object Storage               게임 상태 보존             고가용성
                             모니터링 강화              무중단 배포
```

---

## 참고 자료

- [Naver Cloud Platform 요금](https://www.ncloud.com/charge)
- [NCP Load Balancer WebSocket 지원](https://www.ncloud.com/product/networking/loadBalancer)
- [The Twelve-Factor App](https://12factor.net/)
