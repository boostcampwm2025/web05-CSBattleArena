# 1. 아키텍처 개요

> CS Arena 서비스의 전체 시스템 아키텍처 및 설계 원칙

## 설계 방향

### 비용 최적화 원칙

본 아키텍처는 **월 20~30만원** 예산 내에서 안정적인 서비스 운영을 목표로 합니다.

| 원칙 | 설명 |
|------|------|
| **Self-managed DB** | NCP Cloud DB 대신 일반 서버에 PostgreSQL 직접 구축 |
| **단일 WAS** | Load Balancer 없이 단일 WAS 서버 운영 |
| **서버 분리** | WAS와 DB를 별도 서버로 분리하여 안정성 확보 |
| **선택적 Redis** | 필요 시에만 Redis 도입 |

---

## 시스템 아키텍처 다이어그램

### 현재 목표 아키텍처 (비용 최적화)

```
                                    ┌─────────────────────────────────────────────────────────────┐
                                    │                         NCP VPC                              │
                                    │                                                              │
    ┌──────────┐                    │  ┌─────────────────────────────────────────────────────┐    │
    │  Client  │───HTTPS───────────▶│  │                 Public Subnet                       │    │
    │ (Browser)│                    │  │                                                      │    │
    └──────────┘                    │  │  ┌─────────────────────────────────────────────┐   │    │
         │                          │  │  │            WAS Server (단일)                 │   │    │
         │                          │  │  │                                              │   │    │
         │ WebSocket (wss://)       │  │  │  ┌─────────────┐    ┌─────────────┐        │   │    │
         │                          │  │  │  │   Nginx     │    │   NestJS    │        │   │    │
         └──────────────────────────┼──┼──┼─▶│ (Reverse    │───▶│  Backend    │        │   │    │
                                    │  │  │  │  Proxy)     │    │  + Socket.IO│        │   │    │
                                    │  │  │  └─────────────┘    └──────┬──────┘        │   │    │
                                    │  │  │                            │               │   │    │
                                    │  │  └────────────────────────────┼───────────────┘   │    │
                                    │  │                               │                    │    │
                                    │  └───────────────────────────────┼────────────────────┘    │
                                    │                                  │                          │
                                    │  ┌───────────────────────────────┼────────────────────┐    │
                                    │  │              Private Subnet   │                    │    │
                                    │  │                               ▼                    │    │
                                    │  │  ┌─────────────────────────────────────────────┐  │    │
                                    │  │  │              DB Server                       │  │    │
                                    │  │  │                                              │  │    │
                                    │  │  │  ┌─────────────────┐                        │  │    │
                                    │  │  │  │   PostgreSQL    │                        │  │    │
                                    │  │  │  │   (Primary)     │                        │  │    │
                                    │  │  │  │   + pgvector    │                        │  │    │
                                    │  │  │  └─────────────────┘                        │  │    │
                                    │  │  │                                              │  │    │
                                    │  │  └─────────────────────────────────────────────┘  │    │
                                    │  │                                                    │    │
                                    │  └────────────────────────────────────────────────────┘    │
                                    │                                                              │
                                    └─────────────────────────────────────────────────────────────┘

                                                          │
                                                          ▼
                                    ┌─────────────────────────────────────────────────────────────┐
                                    │                    External Services                         │
                                    │                                                              │
                                    │  ┌─────────────────┐     ┌─────────────────┐                │
                                    │  │  GitHub OAuth   │     │  Clova Studio   │                │
                                    │  │    (인증)        │     │    (AI 채점)    │                │
                                    │  └─────────────────┘     └─────────────────┘                │
                                    │                                                              │
                                    │  ┌─────────────────┐                                        │
                                    │  │ Object Storage  │  ← Frontend 정적 파일                  │
                                    │  │ (React Build)   │                                        │
                                    │  └─────────────────┘                                        │
                                    │                                                              │
                                    └─────────────────────────────────────────────────────────────┘
```

### 미래 확장 아키텍처 (Scale-out 필요 시)

```
                                    ┌─────────────────────────────────────────────────────────────┐
                                    │                         NCP VPC                              │
                                    │                                                              │
    ┌──────────┐                    │  ┌─────────────────┐                                        │
    │  Client  │───HTTPS───────────▶│  │  Global CDN     │                                        │
    │ (Browser)│                    │  │  (정적 파일)     │                                        │
    └──────────┘                    │  └─────────────────┘                                        │
         │                          │           │                                                  │
         │                          │           ▼                                                  │
         │                          │  ┌─────────────────┐     ┌─────────────────────────────┐   │
         │                          │  │ Object Storage  │     │     Public Subnet           │   │
         │                          │  │ (React Build)   │     │  ┌─────────────────────┐    │   │
         │                          │  └─────────────────┘     │  │   Load Balancer     │    │   │
         │                          │                          │  │  (ALB + Sticky)     │    │   │
         │                          │                          │  └──────────┬──────────┘    │   │
         │                          │                          └─────────────┼───────────────┘   │
         │                          │                                        │                    │
         │ WebSocket (wss://)       │                                        ▼                    │
         │                          │  ┌───────────────────────────────────────────────────────┐  │
         └──────────────────────────┼─▶│                 Private Subnet                        │  │
                                    │  │                                                        │  │
                                    │  │  ┌─────────────┐    ┌─────────────┐                   │  │
                                    │  │  │  Backend    │    │  Backend    │                   │  │
                                    │  │  │  Server 1   │    │  Server 2   │   (Auto Scaling)  │  │
                                    │  │  │  (NestJS)   │    │  (NestJS)   │                   │  │
                                    │  │  └──────┬──────┘    └──────┬──────┘                   │  │
                                    │  │         │                  │                          │  │
                                    │  │         └────────┬─────────┘                          │  │
                                    │  │                  │                                    │  │
                                    │  │                  ▼                                    │  │
                                    │  │         ┌───────────────┐                             │  │
                                    │  │         │    Redis      │                             │  │
                                    │  │         │  (Session +   │                             │  │
                                    │  │         │  Socket.IO    │                             │  │
                                    │  │         │   Adapter)    │                             │  │
                                    │  │         └───────────────┘                             │  │
                                    │  │                                                        │  │
                                    │  └───────────────────────────────────────────────────────┘  │
                                    │                          │                                   │
                                    │                          ▼                                   │
                                    │  ┌───────────────────────────────────────────────────────┐  │
                                    │  │                 Database Subnet                       │  │
                                    │  │                                                        │  │
                                    │  │  ┌─────────────────┐     ┌─────────────────┐          │  │
                                    │  │  │   PostgreSQL    │────▶│   PostgreSQL    │          │  │
                                    │  │  │    (Master)     │     │    (Slave)      │          │  │
                                    │  │  │   + pgvector    │ WAL │   Read Replica  │          │  │
                                    │  │  └─────────────────┘     └─────────────────┘          │  │
                                    │  │                                                        │  │
                                    │  └───────────────────────────────────────────────────────┘  │
                                    │                                                              │
                                    └─────────────────────────────────────────────────────────────┘
```

---

## 서버 분리의 이점

### WAS + DB 분리 구성을 선택한 이유

단일 서버에 WAS와 DB를 함께 운영하는 대신 **2대의 서버로 분리**하는 것은 비용 대비 다음과 같은 이점이 있습니다:

| 이점 | 설명 |
|------|------|
| **장애 격리** | DB 장애가 WAS에 영향을 주지 않고, WAS 배포/재시작 시 DB 연결 유지 |
| **리소스 분리** | CPU/메모리를 각 역할에 맞게 최적화 가능 |
| **보안 강화** | DB 서버를 Private Subnet에 배치하여 외부 접근 차단 |
| **유지보수 용이** | WAS 업데이트 시 DB 영향 없음, 독립적 백업/복구 |
| **확장 준비** | 향후 WAS 다중화 또는 DB 복제 시 구조 변경 최소화 |

### WAS 다중화를 하지 않는 이유 (현재)

| 고려사항 | 현재 판단 |
|----------|----------|
| **비용** | Load Balancer (~3만원) + 추가 서버 (~6만원) = 월 9만원 추가 |
| **복잡도** | Redis 필수 도입, Sticky Session 설정 필요 |
| **현재 트래픽** | 부트캠프 프로젝트 수준으로 단일 서버로 충분 |
| **장애 대응** | Docker 기반 빠른 복구 가능, 다운타임 수 분 예상 |

### WAS 다중화 도입 시점 (미래)

다음 조건 충족 시 WAS 다중화 고려:

- 동시 접속자 100명 이상 지속
- CPU 사용률 70% 이상 지속
- 무중단 배포 필수 요구
- 예산 40만원 이상 확보

---

## 설계 원칙

### 1. 계층화 (Layered Architecture)

```
┌────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│              (React SPA + Socket.IO Client)                 │
├────────────────────────────────────────────────────────────┤
│                      Reverse Proxy                          │
│                   (Nginx on WAS Server)                     │
├────────────────────────────────────────────────────────────┤
│                   Application Layer                         │
│      (NestJS Backend + WebSocket Gateway + Services)        │
├────────────────────────────────────────────────────────────┤
│                     Session Layer                           │
│    (In-Memory 현재 → Redis 확장 시: 세션 공유, 매칭 큐)      │
├────────────────────────────────────────────────────────────┤
│                   Persistence Layer                         │
│            (Self-managed PostgreSQL + pgvector)             │
└────────────────────────────────────────────────────────────┘
```

### 2. 실시간 게임 특화 설계 원칙

| 원칙 | 현재 상태 | 미래 상태 (확장 시) |
|------|----------|-------------------|
| **Sticky Session** | 단일 서버로 불필요 | Load Balancer 설정 |
| **State Externalization** | In-Memory | Redis 활용 |
| **Graceful Degradation** | 기본 헬스체크 | 자동 장애조치 |
| **Event-Driven** | Socket.IO | Socket.IO + Redis Pub/Sub |

### 3. 보안 설계 원칙

```
┌─────────────────────────────────────────────────────────────┐
│                        Security Zones                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────┐                                        │
│  │  Public Zone    │  ← WAS Server (Nginx + NestJS)         │
│  │                 │  ← ACG: 80, 443 from Any               │
│  │                 │  ← ACG: 22 from Admin IP only          │
│  └────────┬────────┘                                        │
│           │                                                  │
│  ┌────────▼────────┐                                        │
│  │  Private Zone   │  ← DB Server                           │
│  │  (DB Tier)      │  ← ACG: 5432 from WAS only             │
│  │                 │  ← ACG: 22 from Bastion only           │
│  └─────────────────┘                                        │
│                                                              │
│  ┌─────────────────┐                                        │
│  │  Bastion Host   │  ← DB 관리 접근용 (선택)               │
│  │  (Optional)     │  ← ACG: 22 from Admin IP only          │
│  └─────────────────┘                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 컴포넌트 상세

### Frontend 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend Deployment                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   React Build (Vite)                                        │
│        │                                                     │
│        ▼                                                     │
│   ┌─────────────────┐                                       │
│   │ Object Storage  │  ← 정적 파일 저장 (현재 계획)          │
│   │ (S3 Compatible) │     index.html, *.js, *.css           │
│   └────────┬────────┘                                       │
│            │                                                 │
│            ▼                                                 │
│   사용자 직접 접근 (Object Storage Public URL)              │
│                                                              │
│   ────────────────────────────────────────────────────────  │
│                                                              │
│   [미래 확장 시]                                             │
│   ┌─────────────────┐                                       │
│   │   Global CDN    │  ← 전역 캐싱 및 HTTPS                  │
│   │                 │     Cache-Control: 1 year (assets)    │
│   └─────────────────┘     Cache-Control: no-cache (html)    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Backend 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    Backend Deployment                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   NestJS Application                                        │
│        │                                                     │
│        ├── REST API (/api/*)                                │
│        │      └── Auth, Quiz, User, Match, SinglePlay       │
│        │                                                     │
│        └── WebSocket Gateway (/ws)                          │
│               ├── Game Gateway (게임 진행)                   │
│               └── Matchmaking Gateway (매칭)                 │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              Container Configuration                 │   │
│   ├─────────────────────────────────────────────────────┤   │
│   │  Base Image:     node:22-alpine                     │   │
│   │  Port:           4000                               │   │
│   │  Health Check:   GET /api/health                    │   │
│   │  Memory Limit:   512MB - 2GB                        │   │
│   │  CPU Limit:      0.5 - 2 vCPU                       │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 데이터 흐름

### 1. 인증 흐름 (GitHub OAuth)

```
User                    Frontend           Backend              GitHub
 │                         │                  │                    │
 ├──── Login Click ───────▶│                  │                    │
 │                         ├──── Redirect ───▶│                    │
 │                         │                  ├─── OAuth Request ─▶│
 │◀─────────────────────── GitHub Login Page ─────────────────────│
 │                         │                  │                    │
 ├────────────────────── Login + Authorize ──────────────────────▶│
 │                         │                  │◀── Callback ───────┤
 │                         │                  │     (auth code)    │
 │                         │                  ├─── Token Request ─▶│
 │                         │                  │◀── Access Token ───┤
 │                         │◀─ JWT Token ─────┤                    │
 │◀── Redirect + Token ────┤                  │                    │
 │                         │                  │                    │
```

### 2. 실시간 매칭 흐름 (현재 - 단일 서버)

```
Player A              Backend Server         In-Memory Queue        Player B
   │                        │                      │                    │
   ├─── Join Queue ────────▶│                      │                    │
   │                        ├── Queue Add ────────▶│                    │
   │                        │                      │                    │
   │                        │                      │◀── Join Queue ─────┤
   │                        │◀─── Queue Add ───────┤                    │
   │                        │                      │                    │
   │                        │── Match Found! ──────┤                    │
   │◀── Match Event ────────┤                      ├── Match Event ────▶│
   │                        │                      │                    │
   │◀═══════════════════════╪═══ WebSocket Game ═══╪═══════════════════▶│
   │                        │                      │                    │
```

### 3. 게임 진행 흐름

```
Player A                Backend                PostgreSQL           Player B
   │                       │                       │                   │
   │── Submit Answer ─────▶│                       │                   │
   │                       │── Store (In-Memory) ─▶│                   │
   │                       │                       │                   │
   │                       │◀── Submit Answer ─────┼───────────────────┤
   │                       │                       │                   │
   │                       │      (AI Grading)     │                   │
   │                       │                       │                   │
   │◀─ Round Result ───────┤                       │── Round Result ──▶│
   │                       │                       │                   │
   │                       │ (Game End)            │                   │
   │                       ├── Save to DB ────────▶│                   │
   │                       │                       │                   │
```

---

## 환경 구성

### 환경별 구성

| 환경 | 용도 | 서버 구성 | DB 구성 | 예상 비용 |
|------|------|----------|---------|----------|
| **Development** | 로컬 개발 | Docker Compose | Local PostgreSQL | 0원 |
| **Production** | 실서비스 | WAS 1대 + DB 1대 | Self-managed | ~15만원/월 |
| **Production+** | 확장 시 | WAS 2대 + LB + DB | + Redis | ~35만원/월 |

### 환경 변수 관리

```
┌─────────────────────────────────────────────────────────────┐
│                Environment Configuration                     │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Development (.env.local)                                   │
│  ├── DB_HOST=localhost                                      │
│  ├── NODE_ENV=development                                   │
│  └── DEBUG=true                                             │
│                                                              │
│  Production (서버 환경변수 또는 .env)                        │
│  ├── DB_HOST=${db_server_private_ip}                        │
│  ├── JWT_SECRET=${secure_random_secret}                     │
│  ├── GITHUB_CLIENT_SECRET=${github_oauth_secret}            │
│  └── CLOVA_STUDIO_API_KEY=${clova_api_key}                  │
│                                                              │
│  ⚠️  민감 정보는 절대 Git에 커밋하지 않음                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 모니터링 및 로깅

### 현재 계획 (최소 구성)

```
┌─────────────────────────────────────────────────────────────┐
│                    Basic Monitoring                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  서버 기본 모니터링 (NCP 콘솔)                               │
│  ├── CPU, Memory, Disk Usage                                │
│  └── Network I/O                                            │
│                                                              │
│  애플리케이션 로깅 (Winston → 파일)                          │
│  ├── Application Logs                                       │
│  ├── Error Logs                                             │
│  └── Access Logs (Nginx)                                    │
│                                                              │
│  헬스체크                                                   │
│  └── GET /api/health                                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 미래 확장 (Cloud Insight 도입 시)

```
┌─────────────────────────────────────────────────────────────┐
│                    Full Observability                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Metrics (Cloud Insight)                                    │
│  ├── 시스템 메트릭 자동 수집                                 │
│  ├── Custom Metrics (Active Games, Queue Size)              │
│  └── WebSocket Connection Count                             │
│                                                              │
│  Logs (Cloud Log Analytics)                                 │
│  ├── 중앙 로그 수집                                         │
│  └── 로그 기반 알람                                         │
│                                                              │
│  Alerting                                                   │
│  ├── Server Down Alert                                      │
│  ├── High CPU/Memory Alert (> 80%)                         │
│  └── Error Rate Spike                                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 다음 단계

- [NCP 서비스 가이드](./02-ncp-services.md): 구체적인 NCP 서비스 선택 가이드
- [데이터베이스 아키텍처](./03-database-architecture.md): Self-managed PostgreSQL 구축 가이드
