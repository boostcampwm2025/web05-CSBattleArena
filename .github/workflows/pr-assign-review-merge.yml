name: Auto Assign, Review, and Merge

on:
    pull_request:
        types:
            - opened
            - reopened
    pull_request_review:
        types:
            - submitted

jobs:
    auto-assign:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            issues: write
        steps:
            - name: Assign PR creator as Assignee
              uses: actions/github-script@v6
              with:
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const prAuthor = context.payload.pull_request.user.login;
                      const currentAssignees = context.payload.pull_request.assignees.map(a => a.login);
                      if (!currentAssignees.includes(prAuthor)) {
                          await github.rest.issues.addAssignees({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: prNumber,
                            assignees: [prAuthor]
                          });
                          console.log(`Assigned: ${prAuthor}`);
                      } else {
                          console.log(`Already assigned: ${prAuthor}`);
                      }

    auto-reviewers:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        needs: auto-assign
        permissions:
            pull-requests: write
        steps:
            - name: Add random reviewers
              uses: actions/github-script@v6
              with:
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const prAuthor = context.payload.pull_request.user.login;
                      
                      const allReviewers = ['NAKTA-Y', 'MINU234', 'Enble', 'woghrk12', 'PSW99'];
                      
                      const availableReviewers = allReviewers.filter(r => r !== prAuthor);
                      
                      // Fisher-Yates shuffle
                      for (let i = availableReviewers.length - 1; i > 0; i--) {
                          const j = Math.floor(Math.random() * (i + 1));
                          [availableReviewers[i], availableReviewers[j]] = [availableReviewers[j], availableReviewers[i]];
                      }
                      
                      const selectedReviewers = availableReviewers.slice(0, 3);
                      
                      if (selectedReviewers.length > 0) {
                          try {
                              await github.rest.pulls.requestReviewers({
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  pull_number: prNumber,
                                  reviewers: selectedReviewers
                              });
                              console.log(`Added reviewers: ${selectedReviewers.join(', ')}`);
                          } catch (error) {
                              console.error('Failed to add reviewers:', error);
                          }
                      }
